<ons-page id="hoge">
	<img style="max-width: 90vw;">
	<input type="file" accept="image/*" />

	<input type="form" class="replaceable" value="aaaaa" id="tintin"></input>
	<ul class="replaceableList2" id="text_tag">

	</ul>
	<!-- <button onclick="add_li()">bbb</button> -->
	<script>
		// This is a JavaScript file

function add_li() {
  i = 0;
  card_text.forEach(function (value) {
    // console.log(value);
    $('#text_tag').prepend('<li id = ' + i + '>' + value + '</li>');
    i++;
  });
  $('.replaceableList2 li').replaceable();

}

function substr(text, len, truncation) {
  if (truncation === undefined) { truncation = ''; }
  var text_array = text.split('');
  var count = 0;
  var str = '';
  for (i = 0; i < text_array.length; i++) {
    var n = escape(text_array[i]);
    if (n.length < 4) count++;
    else count += 2;
    if (count > len) {
      return str + truncation;
    }
    str += text.charAt(i);
  }
  return text;
}


(function () {

  'use strict';

  $(function () {

    var replaceable = $('.replaceableList2 li').replaceable();

  });
}());

var element = document.getElementById('tintin');
var texttext;
var texttext2;
//var aiai;
//var ugoku;
	</script>



	<script>
		var card_img;
    var card_text;

    const api_key = `AIzaSyDtz6ZvaRFUbpDJMMfoeWeuq5NLaCy01Tc`;
    const url = `https://vision.googleapis.com/v1/images:annotate`;

    // Send API Request to Cloud Vision API
    const sendAPI = (base64string) => {
      let body = {
        requests: [
          { image: { content: base64string }, features: [{ type: 'TEXT_DETECTION' }] }
        ]
      };
      let xhr = new XMLHttpRequest();
      xhr.open('POST', `${url}?key=${api_key}`, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      const p = new Promise((resolve, reject) => {
        xhr.onreadystatechange = () => {
          if (xhr.readyState != XMLHttpRequest.DONE) return;
          if (xhr.status >= 400) return reject({ message: `Failed with ${xhr.status}:${xhr.statusText}` });
          resolve(JSON.parse(xhr.responseText));
        };
      })
      xhr.send(JSON.stringify(body));
      return p;
    }


    // Read input file
    const readFile = (file) => {
      let reader = new FileReader();
      const p = new Promise((resolve, reject) => {
        reader.onload = (ev) => {
          document.querySelector('img').setAttribute('src', ev.target.result);
          resolve(ev.target.result.replace(/^data:image\/(png|jpeg);base64,/, ''));
        };
      })
      reader.readAsDataURL(file);
      return p;
    };


    // Event handling
    document.querySelector('input').addEventListener('change', ev => {
      if (!ev.target.files || ev.target.files.length == 0) return;
      Promise.resolve(ev.target.files[0])
        .then(readFile)
        .then(sendAPI)
        .then(res => {
          console.log('SUCCESS!', res);
          card_img = JSON.stringify(res, null, 2);
          card_img = JSON.parse(card_img);
          source = card_img.responses[0].textAnnotations[0].description;
          k = (/\n|\s+/);
          card_text = source.split(k);
          // document.querySelector('pre').innerHTML = card_text;
          card_text = $.grep(card_text, function(e){return e !== "";})
          add_li();
          // i=0;
          // card_text.forEach(function (value) {
          //   console.log(card_text[i]);
          //   i++;
          // });
        })
        .catch(err => {
          console.log('FAILED:(', err);
          // document.querySelector('pre').innerHTML = JSON.stringify(err, null, 2);
        });
    });
// console.log(card_img.responses[0].textAnnotations);
// console.log(card_img.responses[0].textAnnotations[0].description);
	</script>

</ons-page>
